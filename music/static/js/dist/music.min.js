function ajax(a,b){return new Ember.RSVP.Promise(function(c,d){b=b||{},b.url=a,Ember.$.ajax(b).done(function(a){"Success"==a.response?c(a):d(new Error(a.message))}).fail(function(b,c,e){d(new Error("AJAX: `"+a+"` failed with status: ["+c+"] "+e))})})}App=Ember.Application.create(),App.Router.map(function(){this.resource("songlists",{path:"/"}),this.resource("songlist",{path:"/songlists/:songlist_id"},function(){this.resource("song",{path:"/:id"}),this.resource("addSong",{path:"/add_song"})})});var MIN_TEMPO=50,MAX_TEMPO=200;App.SonglistsController=Ember.ArrayController.extend({error:null,isEditing:!1,newSonglist:null,isDeleting:!1,title:null,message:null,toDelete:null,currentPage:1,getPage:function(a){var b=this;App.Songlist.getAll(a).then(function(a){var c=a.data.map(function(a){var b=a.songs.map(function(a){return App.Song.create(a)});return a.songs=b,App.Songlist.create(a)});b.set("model",c),b.set("meta",a.meta)})},actions:{newSonglist:function(){this.set("newSonglist",App.Songlist.create({})),this.set("isEditing",!0)},saveSonglist:function(){var a=this;App.Songlist.saveRecord(this.get("newSonglist")).then(function(b){a.set("isEditing",!1),a.set("error",null),a.addObject(App.Songlist.create(b.record)),a.set("newSonglist",null),a.transitionToRoute("songlist",b.record.id)})["catch"](function(b){a.set("error",b.message)})},cancelSonglistEdit:function(){this.set("isEditing",!1),this.set("error",!1)},removeSonglist:function(a){this.set("title","Confirm Deletion"),this.set("message",'Delete song list "'+a.name+'"?'),this.set("toDelete",a),this.set("isDeleting",!0)},cancelDelete:function(){this.set("isDeleting",!1),this.set("title",null),this.set("message",null),this.set("toDelete",null)},confirmDelete:function(){var a=this;App.Songlist.removeSonglist(this.get("toDelete").get("id")).then(function(){var b=a.get("model").indexOf(a.get("toDelete"));a.get("model").removeAt(b,1),a.set("isDeleting",!1),a.set("title",null),a.set("message",null),a.set("toDelete",null)})},nextPage:function(a){this.getPage(a)},previousPage:function(a){this.getPage(a)}}}),App.SonglistController=Ember.ObjectController.extend({error:null,isEditing:!1,actions:{editSonglist:function(){this.set("isEditing",!0)},saveSonglist:function(){var a=this;App.Songlist.saveRecord(this.get("model")).then(function(b){a.set("isEditing",!1),a.set("error",!1)})["catch"](function(b){a.set("error",b.message)})},cancelSonglistEdit:function(){this.set("isEditing",!1),this.set("error",!1),this.send("reloadModel")},songOrder:function(a,b){var c=this,d=this.get("model").get("songs").indexOf(a),e=c.get("model").get("songs");if(!("up"===b&&0===d||"down"===b&&d===e.length-1)){e.splice(d,1),"up"===b?e.splice(d-1,0,a):e.splice(d+1,0,a);var f=[];e.forEach(function(a){f.push(a.get("id"))}),c.get("model").get("songs").setObjects(e),App.Songlist.songOrder(c.get("model").get("id"),f)}},removeSong:function(a){var b=this;App.Songlist.removeSong(b.get("model").get("id"),a.get("id")).then(function(){b.get("model").get("songs").removeObject(a)})}}}),App.SongController=Ember.ObjectController.extend({needs:"songlist",songlist:Ember.computed.alias("controllers.songlist"),isMetroStarted:!1,metronome:null,time_signatures:["","4/4","3/4","6/8"],keys:["","C","C#","Db","D","D#","Eb","E","F","F#","Gb","G","G#","Ab","A","A#","Bb","B"],actions:{metroMinus:function(){var a=this.get("model.tempo");a--,MIN_TEMPO>a&&(a=MIN_TEMPO),this.set("model.tempo",a)},metroPlus:function(){var a=this.get("model.tempo");a++,a>MAX_TEMPO&&(a=MAX_TEMPO),this.set("model.tempo",a)},startMetronome:function(){this.set("isMetroStarted",!0),resetMetronome(),scheduler()},stopMetronome:function(){this.set("isMetroStarted",!1),window.clearTimeout(timerID)},saveSong:function(a){var b=this;App.Song.saveRecord(a).then(function(a){var c=App.Song.create(a.record),d=-1,e=-1;if(b.get("songlist").get("songs").forEach(function(a){return e+=1,a.get("id")==c.get("id")?void(d=e):void 0}),-1!=d){var f=b.get("songlist").get("songs");f[d]=c,b.get("songlist").get("songs").setObjects(f)}})},nextSong:function(){var a,b=this.get("songlist").get("model").get("songs").findBy("id",this.get("model").get("id")),c=this.get("songlist").get("model").get("songs").indexOf(b);a=this.get("songlist").get("model").get("songs").length>c+1?this.get("songlist").get("model").get("songs")[c+1]:this.get("songlist").get("model").get("songs")[0],this.transitionToRoute("song",a.id)},previousSong:function(){var a,b=this.get("songlist").get("model").get("songs").findBy("id",this.get("model").get("id")),c=this.get("songlist").get("model").get("songs").indexOf(b);a=c-1>=0?this.get("songlist").get("model").get("songs")[c-1]:this.get("songlist").get("model").get("songs")[this.get("songlist").get("model").get("songs").length-1],this.transitionToRoute("song",a.id)}},metroTempoChange:function(){var a=this.get("model.tempo");setMetronomeTempo(a)}.observes("model.tempo"),metroBPBChange:function(){var a=4;switch(this.get("model.time_signature")){case"3/4":a=3;break;case"6/8":a=6}setBPB(a)}.observes("model.time_signature")}),App.AddSongController=Ember.ObjectController.extend({search:"",folders:[],actions:{findSong:function(){var a=this;App.Song.findSongs(this.get("search")).then(function(b){var c=b.folders.map(function(b){return b.id=null,b.songlist_id=a.get("model").get("id"),App.Song.create(b)});a.set("folders",c)})},selectSong:function(a){var b=App.Song.create({id:a.get("id"),songlist:this.get("model").get("id"),name:a.get("name"),tempo:a.get("tempo"),key:"",time_signature:a.get("time_signature")}),c=this;App.Song.saveRecord(b).then(function(b){var d=App.Song.create(b.record);c.get("model").get("songs").addObject(d),c.get("folders").removeObject(a)})},addUnlistedSong:function(){var a=App.Song.create({name:"Untitled",songlist:this.get("model").get("id")}),b=this;App.Song.saveRecord(a).then(function(a){var c=App.Song.create(a.record);b.get("model").get("songs").addObject(c)})},closeFind:function(){this.set("search",""),this.set("folders",[]),this.transitionToRoute("songlist",this.get("model").get("id"))},cancelSong:function(){this.set("folders",[]),this.set("search",""),this.transitionToRoute("songlist",this.get("model").get("id"))}}}),App.SongView=Ember.View.extend({didInsertElement:function(){return this.$().attr({tabindex:1}),this.$().focus()},keyDown:function(a,b){return"INPUT"!=a.target.tagName?32===a.keyCode?(this.get("controller").send(this.get("controller").get("isMetroStarted")?"stopMetronome":"startMetronome"),!1):38===a.keyCode?(this.get("controller").send("metroPlus"),!1):40===a.keyCode?(this.get("controller").send("metroMinus"),!1):39===a.keyCode?(this.get("controller").send("nextSong"),!1):37===a.keyCode?(this.get("controller").send("previousSong"),!1):void 0:void 0}}),App.CalendarDatePicker=Ember.TextField.extend({_picker:null,modelChangedValue:function(){var a=this.get("_picker");a&&a.setDate(this.get("value"))}.observes("value"),didInsertElement:function(){var a=(new Date).getFullYear(),b=this.$()[0],c=new Pikaday({field:b,yearRange:[1900,a+2],format:"YYYY-MM-DD"});this.set("_picker",c)},willDestroyElement:function(){var a=this.get("_picker");a&&a.destroy(),this.set("_picker",null)}}),App.Songlist=Ember.Object.extend({}),App.Songlist.reopenClass({url:"/api/songlists",saveRecord:function(a){var b,c={name:a.get("name"),event_date:a.get("event_date")};return a.get("id")?(c.id=a.get("id"),b=this.url+"/"+a.get("id")):b=this.url,ajax(b,{type:"POST",data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})},getAll:function(a){var b={};return a&&(b={page:a}),ajax(this.url,{type:"GET",data:b,contentType:"application/json; charset=utf-8",dataType:"json"})},find:function(a){return ajax(this.url+"/"+a,{type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"})},songOrder:function(a,b){return ajax(this.url+"/"+ +a+"/song_order",{type:"POST",data:JSON.stringify({song_order:b}),contentType:"application/json; charset=utf-8",dataType:"json"})},removeSong:function(a,b){return ajax(this.url+"/"+ +a+"/remove_song",{type:"POST",data:JSON.stringify({song_id:b}),contentType:"application/json; charset=utf-8",dataType:"json"})},removeSonglist:function(a){return ajax(this.url+"/"+ +a,{type:"DELETE",data:JSON.stringify({songlist_id:a}),contentType:"application/json; charset=utf-8",dataType:"json"})}}),App.Song=Ember.Object.extend({}),App.Song.reopenClass({url:"/api/song",findSongs:function(a){return ajax(this.url+"/find",{type:"POST",data:JSON.stringify({q:a}),contentType:"application/json; charset=utf-8",dataType:"json"})},find:function(a){return ajax(this.url+"/"+a,{type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"})},saveRecord:function(a){var b,c={name:a.get("name"),key:a.get("key"),songlist_id:a.get("songlist"),tempo:a.get("tempo"),time_signature:a.get("time_signature")};return a.get("id")?(c.id=a.get("id"),b=this.url+"/"+a.get("id")):b=this.url,ajax(b,{type:"POST",data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})}}),App.SonglistsRoute=Ember.Route.extend({model:function(){return console.log("SonglistsRoute"),App.Songlist.getAll().then(function(a){return a})},setupController:function(a,b){var c=b.data.map(function(a){var b=a.songs.map(function(a){return App.Song.create(a)});return a.songs=b,App.Songlist.create(a)});a.set("content",c),a.set("meta",b.meta)}}),App.SonglistRoute=Ember.Route.extend({model:function(a){return console.log("SonglistRoute: "+a.songlist_id),App.Songlist.find(a.songlist_id).then(function(a){var b=a.songlist.songs.map(function(a){return App.Song.create(a)});return a.songlist.songs=b,App.Songlist.create(a.songlist)})},actions:{reloadModel:function(){this.refresh()}},setupController:function(a,b){this._super(a,b),a.set("isEditing",!1)}}),App.SongRoute=Ember.Route.extend({model:function(a){return console.log("Song:"+a.id),App.Song.find(a.id).then(function(a){return App.Song.create(a.record)})}}),App.AddSongRoute=Ember.Route.extend({renderTemplate:function(){this.render({outlet:"addSong"})}});